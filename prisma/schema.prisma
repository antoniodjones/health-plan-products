generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String        @id @default(uuid())
  email           String        @unique
  passwordHash    String
  firstName       String
  lastName        String
  role            UserRole      @default(PRODUCT_MANAGER)
  organizationId  String?
  isActive        Boolean       @default(true)
  lastLoginAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  auditLogs       AuditLog[]
  createdMappings CodeMapping[] @relation("MappingCreator")
  createdProducts Product[]     @relation("ProductCreator")
  organization    Organization? @relation(fields: [organizationId], references: [id])

  @@map("users")
}

model Organization {
  id        String    @id @default(uuid())
  name      String
  type      OrgType
  domain    String?   @unique
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]
  users     User[]

  @@map("organizations")
}

model CodeSet {
  id              String        @id @default(uuid())
  code            String
  codeType        CodeType
  description     String
  longDescription String?
  category        String?
  isActive        Boolean       @default(true)
  effectiveDate   DateTime
  terminationDate DateTime?
  version         String        @default("1.0")
  sourceSystem    String?
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  mappings        CodeMapping[]
  customCodes     CustomCode[]

  @@unique([code, codeType, version])
  @@index([code, codeType])
  @@index([codeType, isActive])
  @@index([effectiveDate, terminationDate])
  @@map("code_sets")
}

model CodeMapping {
  id                String         @id @default(uuid())
  codeSetId         String
  benefitSegmentId  String
  copay             Float?
  coinsurance       Float?
  deductibleApplies Boolean        @default(true)
  oopApplies        Boolean        @default(true)
  priorAuthRequired Boolean        @default(false)
  stepTherapy       Boolean        @default(false)
  quantityLimit     Int?
  notes             String?
  isActive          Boolean        @default(true)
  priority          Int            @default(1)
  createdById       String
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  benefitSegment    BenefitSegment @relation(fields: [benefitSegmentId], references: [id], onDelete: Cascade)
  codeSet           CodeSet        @relation(fields: [codeSetId], references: [id], onDelete: Cascade)
  createdBy         User           @relation("MappingCreator", fields: [createdById], references: [id])

  @@unique([codeSetId, benefitSegmentId])
  @@index([benefitSegmentId])
  @@index([isActive])
  @@map("code_mappings")
}

model BenefitSegment {
  id                  String               @id @default(uuid())
  name                String
  category            BenefitCategory
  displayOrder        Int
  description         String?
  isEssentialBenefit  Boolean              @default(false)
  isMandated          Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  benefitPackageItems BenefitPackageItem[]
  mappings            CodeMapping[]

  @@unique([name, category])
  @@index([category])
  @@map("benefit_segments")
}

model CustomCode {
  id             String   @id @default(uuid())
  customCode     String   @unique
  name           String
  description    String
  codeSetId      String?
  isPublic       Boolean  @default(false)
  organizationId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  codeSet        CodeSet? @relation(fields: [codeSetId], references: [id])

  @@index([organizationId])
  @@index([isPublic])
  @@map("custom_codes")
}

model Product {
  id                String                @id @default(uuid())
  productId         String                @unique
  name              String
  description       String?
  lineOfBusiness    LineOfBusiness
  marketType        MarketType
  planType          PlanType
  metalTier         MetalTier?
  states            String[]
  effectiveDate     DateTime
  terminationDate   DateTime?
  status            ProductStatus         @default(DRAFT)
  version           String                @default("1.0")
  actuarialValue    Float?
  isActive          Boolean               @default(true)
  organizationId    String?
  createdById       String
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  auditLogRelations AuditLogRelation[]
  plans             Plan[]
  templates         ProductTemplate[]
  createdBy         User                  @relation("ProductCreator", fields: [createdById], references: [id])
  organization      Organization?         @relation(fields: [organizationId], references: [id])
  publications      Publication[]
  ratingConfigs     RatingConfiguration[]

  @@index([productId])
  @@index([status, isActive])
  @@index([lineOfBusiness, marketType])
  @@index([effectiveDate, terminationDate])
  @@map("products")
}

model Plan {
  id               String                 @id @default(uuid())
  planId           String                 @unique
  name             String
  productId        String
  state            String
  counties         String[]
  networkType      NetworkType
  requiresPCP      Boolean                @default(false)
  requiresReferral Boolean                @default(false)
  isActive         Boolean                @default(true)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  benefitPackages  BenefitPackage[]
  networkConfigs   NetworkConfiguration[]
  product          Product                @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([state])
  @@map("plans")
}

model BenefitPackage {
  id                   String               @id @default(uuid())
  name                 String
  planId               String
  packageType          PackageType
  deductibleIndividual Float                @default(0)
  deductibleFamily     Float                @default(0)
  oopMaxIndividual     Float
  oopMaxFamily         Float
  isActive             Boolean              @default(true)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  items                BenefitPackageItem[]
  plan                 Plan                 @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@map("benefit_packages")
}

model BenefitPackageItem {
  id                String         @id @default(uuid())
  benefitPackageId  String
  benefitSegmentId  String
  copay             Float?
  coinsurance       Float?
  deductibleApplies Boolean        @default(true)
  isActive          Boolean        @default(true)
  displayOrder      Int            @default(0)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  benefitPackage    BenefitPackage @relation(fields: [benefitPackageId], references: [id], onDelete: Cascade)
  benefitSegment    BenefitSegment @relation(fields: [benefitSegmentId], references: [id])

  @@unique([benefitPackageId, benefitSegmentId])
  @@index([benefitPackageId])
  @@map("benefit_package_items")
}

model ProductTemplate {
  id           String       @id @default(uuid())
  name         String
  description  String?
  templateType TemplateType
  productId    String?
  isPublic     Boolean      @default(true)
  usageCount   Int          @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  product      Product?     @relation(fields: [productId], references: [id])

  @@index([templateType])
  @@map("product_templates")
}

model RatingConfiguration {
  id                   String    @id @default(uuid())
  productId            String
  state                String
  rateVersion          String
  baseRate             Float
  ageBands             Json
  geoFactors           Json
  tobaccoRate          Float     @default(1.5)
  sicFactors           Json?
  participationRate    Float     @default(0.75)
  contributionStrategy String?
  effectiveDate        DateTime
  expirationDate       DateTime?
  isActive             Boolean   @default(true)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  product              Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, state])
  @@index([effectiveDate, expirationDate])
  @@map("rating_configurations")
}

model ComplianceRule {
  id              String                 @id @default(uuid())
  ruleName        String
  ruleType        ComplianceType
  jurisdiction    String
  description     String
  validationLogic Json
  severity        Severity
  isActive        Boolean                @default(true)
  effectiveDate   DateTime
  expirationDate  DateTime?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  validations     ComplianceValidation[]

  @@index([ruleType, jurisdiction])
  @@index([isActive])
  @@map("compliance_rules")
}

model ComplianceValidation {
  id               String           @id @default(uuid())
  productId        String
  complianceRuleId String
  status           ValidationStatus
  message          String?
  validatedAt      DateTime         @default(now())
  createdAt        DateTime         @default(now())
  complianceRule   ComplianceRule   @relation(fields: [complianceRuleId], references: [id])

  @@index([productId])
  @@index([status])
  @@map("compliance_validations")
}

model Publication {
  id          String             @id @default(uuid())
  productId   String
  channel     PublicationChannel
  publishedAt DateTime?
  status      PublicationStatus  @default(PENDING)
  sbcUrl      String?
  eocUrl      String?
  formId      String?
  metadata    Json?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  product     Product            @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([channel, status])
  @@map("publications")
}

model ProductMetrics {
  id                 String   @id @default(uuid())
  productId          String
  metricDate         DateTime
  enrollment         Int      @default(0)
  claimsPMPM         Float    @default(0)
  medicalLossRatio   Float    @default(0)
  memberSatisfaction Float?
  churnRate          Float?
  metadata           Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([productId, metricDate])
  @@index([productId])
  @@index([metricDate])
  @@map("product_metrics")
}

model NetworkConfiguration {
  id            String   @id @default(uuid())
  planId        String
  networkName   String
  networkId     String
  tierLevel     Int      @default(1)
  providerCount Int?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  plan          Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@map("network_configurations")
}

model AuditLog {
  id         String      @id @default(uuid())
  userId     String
  entityType String
  entityId   String
  action     AuditAction
  changes    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime    @default(now())
  user       User        @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model AuditLogRelation {
  id        String   @id @default(uuid())
  productId String
  logId     String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("audit_log_relations")
}

enum UserRole {
  ADMIN
  PRODUCT_MANAGER
  ACTUARY
  COMPLIANCE_OFFICER
  BENEFIT_DESIGNER
  VIEWER
}

enum OrgType {
  HEALTH_PLAN
  BROKER
  TPA
  CONSULTANT
}

enum CodeType {
  CPT
  HCPCS
  ICD_10_CM
  ICD_10_PCS
  NDC
  LOINC
  SNOMED
  DRG
  REVENUE_CODE
  CUSTOM
}

enum BenefitCategory {
  PREVENTIVE_CARE
  OFFICE_VISITS
  SPECIALIST_VISITS
  URGENT_CARE
  EMERGENCY_CARE
  HOSPITAL_INPATIENT
  HOSPITAL_OUTPATIENT
  SURGERY
  MATERNITY
  MENTAL_HEALTH
  SUBSTANCE_ABUSE
  PHARMACY
  DURABLE_MEDICAL_EQUIPMENT
  LAB_IMAGING
  REHABILITATION
  HOME_HEALTH
  SKILLED_NURSING
  HOSPICE
  DENTAL
  VISION
  HEARING
  TELEHEALTH
  WELLNESS
  CARE_MANAGEMENT
  OTHER
}

enum LineOfBusiness {
  COMMERCIAL
  MEDICARE_ADVANTAGE
  MEDICAID
  CHIP
  EMPLOYER_GROUP
  INDIVIDUAL
}

enum MarketType {
  INDIVIDUAL
  SMALL_GROUP
  LARGE_GROUP
  MEDICARE
  MEDICAID
  EXCHANGE
}

enum PlanType {
  HMO
  PPO
  EPO
  POS
  HDHP
  INDEMNITY
}

enum MetalTier {
  CATASTROPHIC
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum ProductStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  PUBLISHED
  RETIRED
  ARCHIVED
}

enum NetworkType {
  NARROW
  STANDARD
  BROAD
  NATIONAL
}

enum PackageType {
  MEDICAL
  PHARMACY
  DENTAL
  VISION
  SUPPLEMENTAL
  WELLNESS
}

enum TemplateType {
  QUICK_BRONZE
  STANDARD_SILVER_HMO
  FAMILY_GOLD_PPO
  MEDICARE_ADVANTAGE
  SMALL_EMPLOYER_GROUP
}

enum ComplianceType {
  ACA_EHB
  STATE_MANDATE
  NETWORK_ADEQUACY
  MENTAL_HEALTH_PARITY
  ACTUARIAL_VALUE
  RATE_REVIEW
  SBC_REQUIREMENT
}

enum Severity {
  ERROR
  WARNING
  INFO
}

enum ValidationStatus {
  PASSED
  FAILED
  WARNING
  PENDING
}

enum PublicationChannel {
  HEALTHCARE_GOV
  STATE_EXCHANGE
  BROKER_PORTAL
  MEMBER_PORTAL
  SERFF
  CMS
  INTERNAL
}

enum PublicationStatus {
  PENDING
  IN_PROGRESS
  PUBLISHED
  FAILED
  WITHDRAWN
}

enum AuditAction {
  CREATED
  UPDATED
  DELETED
  PUBLISHED
  APPROVED
  REJECTED
  ARCHIVED
}
