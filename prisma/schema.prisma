generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String        @id @default(uuid())
  email           String        @unique
  passwordHash    String
  firstName       String
  lastName        String
  role            UserRole      @default(PRODUCT_MANAGER)
  organizationId  String?
  isActive        Boolean       @default(true)
  lastLoginAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  auditLogs       AuditLog[]
  createdMappings CodeMapping[] @relation("MappingCreator")
  createdProducts Product[]     @relation("ProductCreator")
  organization    Organization? @relation(fields: [organizationId], references: [id])

  @@map("users")
}

model Organization {
  id        String    @id @default(uuid())
  name      String
  type      OrgType
  domain    String?   @unique
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]
  users     User[]

  @@map("organizations")
}

model CodeSet {
  id              String         @id @default(uuid())
  code            String
  codeType        CodeType
  description     String
  longDescription String?
  category        String?
  isActive        Boolean        @default(true)
  effectiveDate   DateTime
  terminationDate DateTime?
  version         String         @default("1.0")
  sourceSystem    String?
  metadata        Json?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  mappings        CodeMapping[]
  customCodes     CustomCode[]
  valueSetCodes   ValueSetCode[] // Quality Measures: Link to value sets
  
  // Code Equivalency (Epic 8)
  sourceEquivalencies EquivalencyMapping[] @relation("SourceCodeEquivalency")
  targetEquivalencies EquivalencyMapping[] @relation("TargetCodeEquivalency")

  @@unique([code, codeType, version])
  @@index([code, codeType])
  @@index([codeType, isActive])
  @@index([effectiveDate, terminationDate])
  @@map("code_sets")
}

model CodeMapping {
  id                String         @id @default(uuid())
  codeSetId         String
  benefitSegmentId  String
  copay             Float?
  coinsurance       Float?
  deductibleApplies Boolean        @default(true)
  oopApplies        Boolean        @default(true)
  priorAuthRequired Boolean        @default(false)
  stepTherapy       Boolean        @default(false)
  quantityLimit     Int?
  notes             String?
  isActive          Boolean        @default(true)
  priority          Int            @default(1)
  createdById       String
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  benefitSegment    BenefitSegment @relation(fields: [benefitSegmentId], references: [id], onDelete: Cascade)
  codeSet           CodeSet        @relation(fields: [codeSetId], references: [id], onDelete: Cascade)
  createdBy         User           @relation("MappingCreator", fields: [createdById], references: [id])

  @@unique([codeSetId, benefitSegmentId])
  @@index([benefitSegmentId])
  @@index([isActive])
  @@map("code_mappings")
}

model BenefitSegment {
  id                  String               @id @default(uuid())
  name                String
  category            BenefitCategory
  displayOrder        Int
  description         String?
  isEssentialBenefit  Boolean              @default(false)
  isMandated          Boolean              @default(false)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  benefitPackageItems BenefitPackageItem[]
  mappings            CodeMapping[]

  @@unique([name, category])
  @@index([category])
  @@map("benefit_segments")
}

model CustomCode {
  id             String   @id @default(uuid())
  customCode     String   @unique
  name           String
  description    String
  codeSetId      String?
  isPublic       Boolean  @default(false)
  organizationId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  codeSet        CodeSet? @relation(fields: [codeSetId], references: [id])

  @@index([organizationId])
  @@index([isPublic])
  @@map("custom_codes")
}

model Product {
  id                String                @id @default(uuid())
  productId         String                @unique
  name              String
  description       String?
  lineOfBusiness    LineOfBusiness
  marketType        MarketType
  planType          PlanType
  metalTier         MetalTier?
  states            String[]
  effectiveDate     DateTime
  terminationDate   DateTime?
  status            ProductStatus         @default(DRAFT)
  version           String                @default("1.0")
  actuarialValue    Float?
  isActive          Boolean               @default(true)
  organizationId    String?
  createdById       String
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  auditLogRelations AuditLogRelation[]
  plans             Plan[]
  templates         ProductTemplate[]
  createdBy         User                  @relation("ProductCreator", fields: [createdById], references: [id])
  organization      Organization?         @relation(fields: [organizationId], references: [id])
  publications      Publication[]
  ratingConfigs     RatingConfiguration[]
  productMeasures   ProductMeasure[] // Quality Measures: Link to quality measures

  @@index([productId])
  @@index([status, isActive])
  @@index([lineOfBusiness, marketType])
  @@index([effectiveDate, terminationDate])
  @@map("products")
}

model Plan {
  id               String                 @id @default(uuid())
  planId           String                 @unique
  name             String
  productId        String
  state            String
  counties         String[]
  networkType      NetworkType
  requiresPCP      Boolean                @default(false)
  requiresReferral Boolean                @default(false)
  isActive         Boolean                @default(true)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  benefitPackages  BenefitPackage[]
  networkConfigs   NetworkConfiguration[]
  product          Product                @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([state])
  @@map("plans")
}

model BenefitPackage {
  id                   String               @id @default(uuid())
  name                 String
  planId               String
  packageType          PackageType
  deductibleIndividual Float                @default(0)
  deductibleFamily     Float                @default(0)
  oopMaxIndividual     Float
  oopMaxFamily         Float
  isActive             Boolean              @default(true)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  items                BenefitPackageItem[]
  plan                 Plan                 @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@map("benefit_packages")
}

model BenefitPackageItem {
  id                String         @id @default(uuid())
  benefitPackageId  String
  benefitSegmentId  String
  copay             Float?
  coinsurance       Float?
  deductibleApplies Boolean        @default(true)
  isActive          Boolean        @default(true)
  displayOrder      Int            @default(0)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  benefitPackage    BenefitPackage @relation(fields: [benefitPackageId], references: [id], onDelete: Cascade)
  benefitSegment    BenefitSegment @relation(fields: [benefitSegmentId], references: [id])

  @@unique([benefitPackageId, benefitSegmentId])
  @@index([benefitPackageId])
  @@map("benefit_package_items")
}

model ProductTemplate {
  id           String       @id @default(uuid())
  name         String
  description  String?
  templateType TemplateType
  productId    String?
  isPublic     Boolean      @default(true)
  usageCount   Int          @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  product      Product?     @relation(fields: [productId], references: [id])

  @@index([templateType])
  @@map("product_templates")
}

model RatingConfiguration {
  id                   String    @id @default(uuid())
  productId            String
  state                String
  rateVersion          String
  baseRate             Float
  ageBands             Json
  geoFactors           Json
  tobaccoRate          Float     @default(1.5)
  sicFactors           Json?
  participationRate    Float     @default(0.75)
  contributionStrategy String?
  effectiveDate        DateTime
  expirationDate       DateTime?
  isActive             Boolean   @default(true)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  product              Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, state])
  @@index([effectiveDate, expirationDate])
  @@map("rating_configurations")
}

model ComplianceRule {
  id              String                 @id @default(uuid())
  ruleName        String
  ruleType        ComplianceType
  jurisdiction    String
  description     String
  validationLogic Json
  severity        Severity
  isActive        Boolean                @default(true)
  effectiveDate   DateTime
  expirationDate  DateTime?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  validations     ComplianceValidation[]

  @@index([ruleType, jurisdiction])
  @@index([isActive])
  @@map("compliance_rules")
}

model ComplianceValidation {
  id               String           @id @default(uuid())
  productId        String
  complianceRuleId String
  status           ValidationStatus
  message          String?
  validatedAt      DateTime         @default(now())
  createdAt        DateTime         @default(now())
  complianceRule   ComplianceRule   @relation(fields: [complianceRuleId], references: [id])

  @@index([productId])
  @@index([status])
  @@map("compliance_validations")
}

model Publication {
  id          String             @id @default(uuid())
  productId   String
  channel     PublicationChannel
  publishedAt DateTime?
  status      PublicationStatus  @default(PENDING)
  sbcUrl      String?
  eocUrl      String?
  formId      String?
  metadata    Json?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  product     Product            @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([channel, status])
  @@map("publications")
}

model ProductMetrics {
  id                 String   @id @default(uuid())
  productId          String
  metricDate         DateTime
  enrollment         Int      @default(0)
  claimsPMPM         Float    @default(0)
  medicalLossRatio   Float    @default(0)
  memberSatisfaction Float?
  churnRate          Float?
  metadata           Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([productId, metricDate])
  @@index([productId])
  @@index([metricDate])
  @@map("product_metrics")
}

model NetworkConfiguration {
  id            String   @id @default(uuid())
  planId        String
  networkName   String
  networkId     String
  tierLevel     Int      @default(1)
  providerCount Int?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  plan          Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@map("network_configurations")
}

model AuditLog {
  id         String      @id @default(uuid())
  userId     String
  entityType String
  entityId   String
  action     AuditAction
  changes    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime    @default(now())
  user       User        @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model AuditLogRelation {
  id        String   @id @default(uuid())
  productId String
  logId     String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("audit_log_relations")
}

enum UserRole {
  ADMIN
  PRODUCT_MANAGER
  ACTUARY
  COMPLIANCE_OFFICER
  BENEFIT_DESIGNER
  VIEWER
}

enum OrgType {
  HEALTH_PLAN
  BROKER
  TPA
  CONSULTANT
}

enum CodeType {
  CPT
  HCPCS
  ICD_10_CM
  ICD_10_PCS
  NDC
  LOINC
  SNOMED
  DRG
  REVENUE_CODE
  CUSTOM
}

enum BenefitCategory {
  PREVENTIVE_CARE
  OFFICE_VISITS
  SPECIALIST_VISITS
  URGENT_CARE
  EMERGENCY_CARE
  HOSPITAL_INPATIENT
  HOSPITAL_OUTPATIENT
  SURGERY
  MATERNITY
  MENTAL_HEALTH
  SUBSTANCE_ABUSE
  PHARMACY
  DURABLE_MEDICAL_EQUIPMENT
  LAB_IMAGING
  REHABILITATION
  HOME_HEALTH
  SKILLED_NURSING
  HOSPICE
  DENTAL
  VISION
  HEARING
  TELEHEALTH
  WELLNESS
  CARE_MANAGEMENT
  OTHER
}

enum LineOfBusiness {
  COMMERCIAL
  MEDICARE_ADVANTAGE
  MEDICAID
  CHIP
  EMPLOYER_GROUP
  INDIVIDUAL
}

enum MarketType {
  INDIVIDUAL
  SMALL_GROUP
  LARGE_GROUP
  MEDICARE
  MEDICAID
  EXCHANGE
}

enum PlanType {
  HMO
  PPO
  EPO
  POS
  HDHP
  INDEMNITY
}

enum MetalTier {
  CATASTROPHIC
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum ProductStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  PUBLISHED
  RETIRED
  ARCHIVED
}

enum NetworkType {
  NARROW
  STANDARD
  BROAD
  NATIONAL
}

enum PackageType {
  MEDICAL
  PHARMACY
  DENTAL
  VISION
  SUPPLEMENTAL
  WELLNESS
}

enum TemplateType {
  QUICK_BRONZE
  STANDARD_SILVER_HMO
  FAMILY_GOLD_PPO
  MEDICARE_ADVANTAGE
  SMALL_EMPLOYER_GROUP
}

enum ComplianceType {
  ACA_EHB
  STATE_MANDATE
  NETWORK_ADEQUACY
  MENTAL_HEALTH_PARITY
  ACTUARIAL_VALUE
  RATE_REVIEW
  SBC_REQUIREMENT
}

enum Severity {
  ERROR
  WARNING
  INFO
}

enum ValidationStatus {
  PASSED
  FAILED
  WARNING
  PENDING
}

enum PublicationChannel {
  HEALTHCARE_GOV
  STATE_EXCHANGE
  BROKER_PORTAL
  MEMBER_PORTAL
  SERFF
  CMS
  INTERNAL
}

enum PublicationStatus {
  PENDING
  IN_PROGRESS
  PUBLISHED
  FAILED
  WITHDRAWN
}

enum AuditAction {
  CREATED
  UPDATED
  DELETED
  PUBLISHED
  APPROVED
  REJECTED
  ARCHIVED
}

// ============================================================================
// QUALITY MEASURES ENUMS
// ============================================================================

enum QualityProgram {
  HEDIS
  MIPS
  PQRS
  NQF
  CMS_STAR
  CUSTOM
}

enum MeasureDomain {
  EFFECTIVENESS_OF_CARE
  ACCESS_AVAILABILITY
  EXPERIENCE_OF_CARE
  UTILIZATION
  HEALTH_PLAN_DESCRIPTIVE
  CLINICAL_DATA_SYSTEMS
  PREVENTION
  CHRONIC_CARE
  BEHAVIORAL_HEALTH
  PATIENT_SAFETY
}

enum MeasureStatus {
  ACTIVE
  RETIRED
  DRAFT
  DEPRECATED
}

enum LogicType {
  DENOMINATOR
  NUMERATOR
  EXCLUSION
  EXCEPTION
  STRATIFICATION
}

// ============================================================================
// CODE EQUIVALENCY ENUMS (Epic 8)
// ============================================================================

enum EquivalencyCategory {
  LABORATORY
  PROCEDURE
  DIAGNOSIS
  MEDICATION
  OBSERVATION
  SERVICE
  SUPPLY
  DME
}

enum EquivalencySource {
  MANUAL
  CMS_CROSSWALK
  NLM_UMLS
  AI_SUGGESTED
  IMPORTED
}

enum EquivalencyRelationship {
  EXACT // Same clinical concept
  BROADER // Target is more general
  NARROWER // Target is more specific
  RELATED // Clinically related but not identical
}

// ============================================================================
// QUALITY MEASURES MODELS
// ============================================================================

model QualityMeasure {
  id             String         @id @default(uuid())
  measureId      String         @unique // e.g., "CDC-H9", "MIPS-001"
  name           String // "Diabetes HbA1c Control"
  description    String         @db.Text
  program        QualityProgram
  domain         MeasureDomain
  version        String         @default("1.0")
  effectiveDate  DateTime
  retirementDate DateTime?
  status         MeasureStatus  @default(ACTIVE)

  // Metadata
  nqfNumber String? // National Quality Forum ID
  cmsNumber String? // CMS measure number
  steward   String? // Measure steward (NCQA, CMS, etc.)

  // Reporting
  reportingMethod String? // "Claims", "Registry", "EHR", "Hybrid"
  measureType     String? // "Process", "Outcome", "Structure"

  // Performance
  nationalBenchmark Float?
  targetRate        Float?

  // Relationships
  measureLogic    MeasureLogic[]
  productMeasures ProductMeasure[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([program, domain])
  @@index([status, effectiveDate])
  @@map("quality_measures")
}

model ValueSet {
  id          String  @id @default(uuid())
  valueSetId  String  @unique // e.g., "2.16.840.1.113883.3.464.1003.103.12.1001"
  name        String // "Diabetes Diagnosis Codes"
  description String? @db.Text
  oid         String? // Object Identifier for interoperability
  version     String  @default("1.0")
  purpose     String? // "Denominator", "Numerator", etc.

  effectiveDate  DateTime
  expirationDate DateTime?

  // Relationships
  codes        ValueSetCode[]
  measureLogic MeasureLogic[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([oid])
  @@map("value_sets")
}

model ValueSetCode {
  id         String @id @default(uuid())
  valueSetId String
  codeSetId  String

  // Inclusion/Exclusion
  included Boolean @default(true)
  notes    String?

  // Relationships
  valueSet ValueSet @relation(fields: [valueSetId], references: [id], onDelete: Cascade)
  codeSet  CodeSet  @relation(fields: [codeSetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([valueSetId, codeSetId])
  @@index([valueSetId])
  @@index([codeSetId])
  @@map("value_set_codes")
}

model MeasureLogic {
  id        String    @id @default(uuid())
  measureId String
  logicType LogicType
  sequence  Int       @default(0) // Order of logic evaluation

  // Value Set Reference
  valueSetId String?

  // Logic Operators
  operator       String? // "AND", "OR", "NOT", "AT_LEAST_ONE"
  timeframeValue Int? // e.g., 365 days
  timeframeUnit  String? // "DAYS", "MONTHS", "YEARS"

  // Age/Demographics
  ageMin Int?
  ageMax Int?
  gender String?

  // Additional Criteria
  criteriaJson Json? // Flexible JSON for complex logic

  // Relationships
  measure  QualityMeasure @relation(fields: [measureId], references: [id], onDelete: Cascade)
  valueSet ValueSet?      @relation(fields: [valueSetId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([measureId, logicType])
  @@map("measure_logic")
}

model ProductMeasure {
  id        String @id @default(uuid())
  productId String
  measureId String

  // Tracking
  isRequired    Boolean @default(false)
  reportingYear Int
  targetRate    Float?

  // Relationships
  product Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  measure QualityMeasure @relation(fields: [measureId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, measureId, reportingYear])
  @@index([productId])
  @@index([measureId])
  @@map("product_measures")
}

// ============================================================================
// CODE EQUIVALENCY & INTEROPERABILITY (Epic 8)
// ============================================================================

model CodeEquivalency {
  id          String   @id @default(uuid())
  name        String   // "HbA1c Test"
  description String   // "Hemoglobin A1c measurement"
  category    EquivalencyCategory

  // Source & Confidence
  source     EquivalencySource @default(MANUAL)
  confidence Float             @default(1.0) // 0.0-1.0

  // Metadata
  metadata Json?

  // Relationships
  mappings EquivalencyMapping[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // User ID

  @@index([category])
  @@index([source, confidence])
  @@map("code_equivalencies")
}

model EquivalencyMapping {
  id             String @id @default(uuid())
  equivalencyId  String
  sourceCodeId   String // FK to CodeSet
  targetCodeId   String // FK to CodeSet
  relationship   EquivalencyRelationship
  bidirectional  Boolean                 @default(true)
  confidence     Float                   @default(1.0)
  validFrom      DateTime                @default(now())
  validTo        DateTime?

  // Relationships
  equivalency CodeEquivalency @relation(fields: [equivalencyId], references: [id], onDelete: Cascade)
  sourceCode  CodeSet         @relation("SourceCodeEquivalency", fields: [sourceCodeId], references: [id], onDelete: Cascade)
  targetCode  CodeSet         @relation("TargetCodeEquivalency", fields: [targetCodeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sourceCodeId, targetCodeId, relationship])
  @@index([equivalencyId])
  @@index([sourceCodeId])
  @@index([targetCodeId])
  @@map("equivalency_mappings")
}

model DeduplicationEvent {
  id       String @id @default(uuid())
  memberId String

  // Primary Event (first occurrence)
  primaryEventSource String // "claim", "emr", "lab", "rx"
  primaryEventId     String
  primaryEventDate   DateTime
  primaryCodeType    String
  primaryCode        String
  primaryDescription String?

  // Deduplication Analysis
  duplicateCount    Int      @default(0)
  duplicateSources  String[] // ["emr", "claim"]
  duplicateEventIds String[] // ["event-002", "event-003"]

  // Matching Criteria
  matchingCriteria String // "exact_code", "equivalent_code", "temporal_proximity"
  temporalWindow   Int? // hours
  confidence       Float   @default(1.0)

  // Impact
  alertsAvoided           Int @default(0)
  incorrectClosuresAvoided Int @default(0)
  timeSavedMinutes        Int @default(0)

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([memberId, primaryEventDate])
  @@index([primaryCodeType, primaryCode])
  @@map("deduplication_events")
}
