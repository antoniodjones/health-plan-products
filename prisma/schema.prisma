// Products & Benefits Platform - Complete Database Schema
// Covers all 12 Epics across 5 phases

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// PHASE 0: AUTHENTICATION & USER MANAGEMENT
// ============================================================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  role          UserRole  @default(PRODUCT_MANAGER)
  organizationId String?
  organization  Organization? @relation(fields: [organizationId], references: [id])
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  createdProducts   Product[]   @relation("ProductCreator")
  createdMappings   CodeMapping[] @relation("MappingCreator")
  auditLogs         AuditLog[]

  @@map("users")
}

enum UserRole {
  ADMIN
  PRODUCT_MANAGER
  ACTUARY
  COMPLIANCE_OFFICER
  BENEFIT_DESIGNER
  VIEWER
}

model Organization {
  id          String   @id @default(uuid())
  name        String
  type        OrgType
  domain      String?  @unique
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  products    Product[]

  @@map("organizations")
}

enum OrgType {
  HEALTH_PLAN
  BROKER
  TPA
  CONSULTANT
}

// ============================================================================
// PHASE 1: CODE MANAGEMENT (Epics 1-5)
// ============================================================================

// Epic 1: Code Set Data Management
model CodeSet {
  id              String      @id @default(uuid())
  code            String
  codeType        CodeType
  description     String
  longDescription String?
  category        String?
  isActive        Boolean     @default(true)
  effectiveDate   DateTime
  terminationDate DateTime?
  version         String      @default("1.0")
  sourceSystem    String?     // CMS, AMA, etc.
  metadata        Json?       // Additional flexible data
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relationships
  mappings        CodeMapping[]
  customCodes     CustomCode[]

  @@unique([code, codeType, version])
  @@index([code, codeType])
  @@index([codeType, isActive])
  @@index([effectiveDate, terminationDate])
  @@map("code_sets")
}

enum CodeType {
  CPT           // Current Procedural Terminology
  HCPCS         // Healthcare Common Procedure Coding System
  ICD_10_CM     // Diagnosis codes
  ICD_10_PCS    // Procedure codes
  NDC           // National Drug Code
  LOINC         // Lab codes
  SNOMED        // Clinical terms
  DRG           // Diagnosis Related Group
  REVENUE_CODE  // UB-04 revenue codes
  CUSTOM        // Health plan proprietary codes
}

// Epic 2: Code-to-Benefit Mapping
model CodeMapping {
  id                String      @id @default(uuid())
  codeSetId         String
  codeSet           CodeSet     @relation(fields: [codeSetId], references: [id], onDelete: Cascade)
  benefitSegmentId  String
  benefitSegment    BenefitSegment @relation(fields: [benefitSegmentId], references: [id], onDelete: Cascade)
  copay             Float?
  coinsurance       Float?      // Percentage (e.g., 0.20 for 20%)
  deductibleApplies Boolean     @default(true)
  oopApplies        Boolean     @default(true)
  priorAuthRequired Boolean     @default(false)
  stepTherapy       Boolean     @default(false)
  quantityLimit     Int?
  notes             String?
  isActive          Boolean     @default(true)
  priority          Int         @default(1)
  createdById       String
  createdBy         User        @relation("MappingCreator", fields: [createdById], references: [id])
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@unique([codeSetId, benefitSegmentId])
  @@index([benefitSegmentId])
  @@index([isActive])
  @@map("code_mappings")
}

// Epic 4: Benefit Segments (Categories)
model BenefitSegment {
  id                  String      @id @default(uuid())
  name                String
  category            BenefitCategory
  displayOrder        Int
  description         String?
  isEssentialBenefit  Boolean     @default(false)  // ACA EHB
  isMandated          Boolean     @default(false)  // State/Federal mandate
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  // Relationships
  mappings            CodeMapping[]
  benefitPackageItems BenefitPackageItem[]

  @@unique([name, category])
  @@index([category])
  @@map("benefit_segments")
}

enum BenefitCategory {
  PREVENTIVE_CARE
  OFFICE_VISITS
  SPECIALIST_VISITS
  URGENT_CARE
  EMERGENCY_CARE
  HOSPITAL_INPATIENT
  HOSPITAL_OUTPATIENT
  SURGERY
  MATERNITY
  MENTAL_HEALTH
  SUBSTANCE_ABUSE
  PHARMACY
  DURABLE_MEDICAL_EQUIPMENT
  LAB_IMAGING
  REHABILITATION
  HOME_HEALTH
  SKILLED_NURSING
  HOSPICE
  DENTAL
  VISION
  HEARING
  TELEHEALTH
  WELLNESS
  CARE_MANAGEMENT
  OTHER
}

// Epic 5: Custom/Proprietary Codes
model CustomCode {
  id              String    @id @default(uuid())
  customCode      String    @unique
  name            String
  description     String
  codeSetId       String?   // Link to standard code if derivative
  codeSet         CodeSet?  @relation(fields: [codeSetId], references: [id])
  isPublic        Boolean   @default(false)  // Shareable in marketplace
  organizationId  String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([organizationId])
  @@index([isPublic])
  @@map("custom_codes")
}

// ============================================================================
// PHASE 2: PRODUCT MANAGEMENT (Epics 6-8)
// ============================================================================

// Epic 6: Product Catalog & Management
model Product {
  id                String        @id @default(uuid())
  productId         String        @unique  // Business ID (e.g., "GOLD-PPO-2026-CA")
  name              String
  description       String?
  lineOfBusiness    LineOfBusiness
  marketType        MarketType
  planType          PlanType
  metalTier         MetalTier?
  states            String[]      // Array of state codes
  effectiveDate     DateTime
  terminationDate   DateTime?
  status            ProductStatus @default(DRAFT)
  version           String        @default("1.0")
  actuarialValue    Float?        // 0-1 (e.g., 0.80 for 80%)
  isActive          Boolean       @default(true)
  organizationId    String?
  organization      Organization? @relation(fields: [organizationId], references: [id])
  createdById       String
  createdBy         User          @relation("ProductCreator", fields: [createdById], references: [id])
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relationships
  plans             Plan[]
  templates         ProductTemplate[]
  ratingConfigs     RatingConfiguration[]
  publications      Publication[]
  auditLogRelations AuditLogRelation[]

  @@index([productId])
  @@index([status, isActive])
  @@index([lineOfBusiness, marketType])
  @@index([effectiveDate, terminationDate])
  @@map("products")
}

enum LineOfBusiness {
  COMMERCIAL
  MEDICARE_ADVANTAGE
  MEDICAID
  CHIP
  EMPLOYER_GROUP
  INDIVIDUAL
}

enum MarketType {
  INDIVIDUAL
  SMALL_GROUP
  LARGE_GROUP
  MEDICARE
  MEDICAID
  EXCHANGE
}

enum PlanType {
  HMO
  PPO
  EPO
  POS
  HDHP
  INDEMNITY
}

enum MetalTier {
  CATASTROPHIC
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

enum ProductStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  PUBLISHED
  RETIRED
  ARCHIVED
}

// Epic 6: Plan (Child of Product)
model Plan {
  id                String    @id @default(uuid())
  planId            String    @unique  // Business ID
  name              String
  productId         String
  product           Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  state             String    // Two-letter state code
  counties          String[]  // Array of county names
  networkType       NetworkType
  requiresPCP       Boolean   @default(false)
  requiresReferral  Boolean   @default(false)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relationships
  benefitPackages   BenefitPackage[]
  networkConfigs    NetworkConfiguration[]

  @@index([productId])
  @@index([state])
  @@map("plans")
}

enum NetworkType {
  NARROW
  STANDARD
  BROAD
  NATIONAL
}

// Epic 7: Benefit Design Studio - Benefit Packages
model BenefitPackage {
  id                  String    @id @default(uuid())
  name                String
  planId              String
  plan                Plan      @relation(fields: [planId], references: [id], onDelete: Cascade)
  packageType         PackageType
  deductibleIndividual Float    @default(0)
  deductibleFamily    Float     @default(0)
  oopMaxIndividual    Float
  oopMaxFamily        Float
  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relationships
  items               BenefitPackageItem[]

  @@index([planId])
  @@map("benefit_packages")
}

enum PackageType {
  MEDICAL
  PHARMACY
  DENTAL
  VISION
  SUPPLEMENTAL
  WELLNESS
}

// Epic 7: Benefit Package Items (Maps BenefitSegments to Packages)
model BenefitPackageItem {
  id                String          @id @default(uuid())
  benefitPackageId  String
  benefitPackage    BenefitPackage  @relation(fields: [benefitPackageId], references: [id], onDelete: Cascade)
  benefitSegmentId  String
  benefitSegment    BenefitSegment  @relation(fields: [benefitSegmentId], references: [id])
  copay             Float?
  coinsurance       Float?
  deductibleApplies Boolean         @default(true)
  isActive          Boolean         @default(true)
  displayOrder      Int             @default(0)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@unique([benefitPackageId, benefitSegmentId])
  @@index([benefitPackageId])
  @@map("benefit_package_items")
}

// Epic 8: Product Templates
model ProductTemplate {
  id              String    @id @default(uuid())
  name            String
  description     String?
  templateType    TemplateType
  productId       String?   // Base product for template
  product         Product?  @relation(fields: [productId], references: [id])
  isPublic        Boolean   @default(true)
  usageCount      Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([templateType])
  @@map("product_templates")
}

enum TemplateType {
  QUICK_BRONZE
  STANDARD_SILVER_HMO
  FAMILY_GOLD_PPO
  MEDICARE_ADVANTAGE
  SMALL_EMPLOYER_GROUP
}

// ============================================================================
// PHASE 3: RATING ENGINE (Epic 9)
// ============================================================================

model RatingConfiguration {
  id              String    @id @default(uuid())
  productId       String
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  state           String
  rateVersion     String
  baseRate        Float     // PMPM (Per Member Per Month)
  ageBands        Json      // Age rating factors
  geoFactors      Json      // Geographic adjustment factors
  tobaccoRate     Float     @default(1.5)  // Tobacco user multiplier
  sicFactors      Json?     // Industry-based factors
  participationRate Float   @default(0.75)
  contributionStrategy String?
  effectiveDate   DateTime
  expirationDate  DateTime?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([productId, state])
  @@index([effectiveDate, expirationDate])
  @@map("rating_configurations")
}

// ============================================================================
// PHASE 4: COMPLIANCE ENGINE (Epic 10)
// ============================================================================

model ComplianceRule {
  id              String          @id @default(uuid())
  ruleName        String
  ruleType        ComplianceType
  jurisdiction    String          // Federal, State code, or ALL
  description     String
  validationLogic Json            // Stored validation rules
  severity        Severity
  isActive        Boolean         @default(true)
  effectiveDate   DateTime
  expirationDate  DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  validations     ComplianceValidation[]

  @@index([ruleType, jurisdiction])
  @@index([isActive])
  @@map("compliance_rules")
}

enum ComplianceType {
  ACA_EHB
  STATE_MANDATE
  NETWORK_ADEQUACY
  MENTAL_HEALTH_PARITY
  ACTUARIAL_VALUE
  RATE_REVIEW
  SBC_REQUIREMENT
}

enum Severity {
  ERROR
  WARNING
  INFO
}

model ComplianceValidation {
  id              String          @id @default(uuid())
  productId       String
  complianceRuleId String
  complianceRule  ComplianceRule  @relation(fields: [complianceRuleId], references: [id])
  status          ValidationStatus
  message         String?
  validatedAt     DateTime        @default(now())
  createdAt       DateTime        @default(now())

  @@index([productId])
  @@index([status])
  @@map("compliance_validations")
}

enum ValidationStatus {
  PASSED
  FAILED
  WARNING
  PENDING
}

// ============================================================================
// PHASE 5: PUBLISHING & ANALYTICS (Epics 11-12)
// ============================================================================

// Epic 11: Product Publishing
model Publication {
  id              String            @id @default(uuid())
  productId       String
  product         Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  channel         PublicationChannel
  publishedAt     DateTime?
  status          PublicationStatus @default(PENDING)
  sbcUrl          String?           // Summary of Benefits & Coverage
  eocUrl          String?           // Evidence of Coverage
  formId          String?           // SERFF filing ID
  metadata        Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([productId])
  @@index([channel, status])
  @@map("publications")
}

enum PublicationChannel {
  HEALTHCARE_GOV
  STATE_EXCHANGE
  BROKER_PORTAL
  MEMBER_PORTAL
  SERFF
  CMS
  INTERNAL
}

enum PublicationStatus {
  PENDING
  IN_PROGRESS
  PUBLISHED
  FAILED
  WITHDRAWN
}

// Epic 12: Performance Analytics
model ProductMetrics {
  id              String    @id @default(uuid())
  productId       String
  metricDate      DateTime
  enrollment      Int       @default(0)
  claimsPMPM      Float     @default(0)
  medicalLossRatio Float    @default(0)
  memberSatisfaction Float?
  churnRate       Float?
  metadata        Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([productId, metricDate])
  @@index([productId])
  @@index([metricDate])
  @@map("product_metrics")
}

// ============================================================================
// NETWORK CONFIGURATION
// ============================================================================

model NetworkConfiguration {
  id              String    @id @default(uuid())
  planId          String
  plan            Plan      @relation(fields: [planId], references: [id], onDelete: Cascade)
  networkName     String
  networkId       String
  tierLevel       Int       @default(1)
  providerCount   Int?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([planId])
  @@map("network_configurations")
}

// ============================================================================
// AUDIT & LOGGING
// ============================================================================

model AuditLog {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  entityType      String    // Product, Plan, CodeMapping, etc.
  entityId        String
  action          AuditAction
  changes         Json?     // Before/after state
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model AuditLogRelation {
  id              String    @id @default(uuid())
  productId       String
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  logId           String
  createdAt       DateTime  @default(now())

  @@index([productId])
  @@map("audit_log_relations")
}

enum AuditAction {
  CREATED
  UPDATED
  DELETED
  PUBLISHED
  APPROVED
  REJECTED
  ARCHIVED
}

